# Phân tích chi tiết quy tắc cá cược xổ số

## 1. Danh sách các loại cược

Dựa trên tài liệu, đây là tất cả các loại cược được hỗ trợ:

- **Đầu Đuôi (dd)** - Cược dựa trên số ở giải 8 (M1)/giải 7 (M2) và 2 số cuối giải đặc biệt
- **Xỉu Chủ (xc)** - Cược dựa trên số ở giải 7 (M1)/giải 6 (M2) và 3 số cuối giải đặc biệt
- **Bao Lô N (b2, b3, b4)** - Cược khớp với N số cuối của bất kỳ lô nào trong các giải
- **Bao 7 Lô (b7l)** - Cược khớp với số cuối của 7 lô cụ thể ở M1
- **Bao 8 Lô (b8l)** - Cược khớp với số cuối của 8 lô cụ thể ở M2
- **Nhất To (nt)** - Cược khớp với 2 số cuối của giải Nhất (M2)
- **Xiên (x)** - Cược khi tất cả các cặp số xuất hiện trong kết quả (M2)
- **Đá (da)** - Cược phức tạp với nhiều trường hợp trúng dựa trên 2-5 cặp số (M1)

## 2. Tóm tắt chi tiết từng loại cược

### 2.1 Đầu Đuôi (dd)

**Nguyên tắc cơ bản:**

- Người chơi đặt số có 2 chữ số (00-99)
- 3 cách chơi: đầu đuôi (dd), chỉ đầu (dau), chỉ đuôi (duoi)

**Cách tính tiền đóng:**

- Đầu đuôi (dd): M1 (mệnh giá × 2), M2 (mệnh giá × 5)
- Chỉ đầu (dau): M1 (mệnh giá × 1), M2 (mệnh giá × 4)
- Chỉ đuôi (duoi): M1 và M2 (mệnh giá × 1)

**Tỷ lệ thắng:** 1 ăn 75 (1:75)

**Áp dụng:** Cả M1 và M2

### 2.2 Xỉu Chủ (xc)

**Nguyên tắc cơ bản:**

- Người chơi đặt số có 3 chữ số (000-999)
- 3 cách chơi: xỉu chủ toàn phần (xc), chỉ đầu (dau), chỉ đuôi (duoi)

**Cách tính tiền đóng:**

- Xỉu chủ toàn phần (xc): M1 (mệnh giá × 2), M2 (mệnh giá × 4)
- Chỉ đầu (dau): M1 (mệnh giá × 1), M2 (mệnh giá × 3)
- Chỉ đuôi (duoi): M1 và M2 (mệnh giá × 1)

**Tỷ lệ thắng:** 1 ăn 650 (1:650)

**Áp dụng:** Cả M1 và M2

### 2.3 Bao Lô N (b2, b3, b4)

**Nguyên tắc cơ bản:**

- Người chơi đặt số có N chữ số (N = 2, 3 hoặc 4)
- Số cược khớp với N số cuối của bất kỳ lô nào trong các giải

**Cách tính tiền đóng:**

- Bao Lô 2: M1 (mệnh giá × 18), M2 (mệnh giá × 27)
- Bao Lô 3: M1 (mệnh giá × 17), M2 (mệnh giá × 23)
- Bao Lô 4: M1 (mệnh giá × 16), M2 (mệnh giá × 20)

**Tỷ lệ thắng:**

- Bao Lô 2: 1 ăn 75 (1:75)
- Bao Lô 3: 1 ăn 650 (1:650)
- Bao Lô 4: 1 ăn 5500 (1:5500)

**Áp dụng:** Cả M1 và M2

### 2.4 Bao 7 Lô (b7l)

**Nguyên tắc cơ bản:**

- Người chơi đặt số có 2, 3 hoặc 4 chữ số
- Số cược khớp với 2, 3 hoặc 4 số cuối của 7 lô cụ thể ở M1

**Cách tính tiền đóng:** M1 (mệnh giá × 7)

**Tỷ lệ thắng:**

- 2 chữ số: 1 ăn 75 (1:75)
- 3 chữ số: 1 ăn 650 (1:650)
- 4 chữ số: 1 ăn 5500 (1:5500)

**Áp dụng:** Chủ yếu M1

### 2.5 Bao 8 Lô (b8l)

**Nguyên tắc cơ bản:**

- Người chơi đặt số có 2, 3 hoặc 4 chữ số
- Số cược khớp với 2, 3 hoặc 4 số cuối của 8 lô cụ thể ở M2

**Cách tính tiền đóng:** M2 (mệnh giá × 8)

**Tỷ lệ thắng:**

- 2 chữ số: 1 ăn 75 (1:75)
- 3 chữ số: 1 ăn 650 (1:650)
- 4 chữ số: 1 ăn 5500 (1:5500)

**Áp dụng:** Chủ yếu M2

### 2.6 Nhất To (nt)

**Nguyên tắc cơ bản:**

- Người chơi đặt số có 2 chữ số
- Số cược khớp với 2 số cuối của giải Nhất ở M2

**Cách tính tiền đóng:** M2 (mệnh giá × 1)

**Tỷ lệ thắng:** 1 ăn 75 (1:75)

**Áp dụng:** Chủ yếu M2

### 2.7 Xiên (x)

**Nguyên tắc cơ bản:**

- Người chơi chọn 2, 3 hoặc 4 cặp số (mỗi cặp có 2 chữ số)
- Để thắng, tất cả các cặp số đều phải xuất hiện trong kết quả

**Cách tính tiền đóng:** M2 (mệnh giá × 27)

**Tỷ lệ thắng:**

- Xiên 2 (2 cặp số): 1 ăn 75 (1:75)
- Xiên 3 (3 cặp số): 1 ăn 40 (1:40)
- Xiên 4 (4 cặp số): 1 ăn 250 (1:250)

**Áp dụng:** Chủ yếu M2

### 2.8 Đá (da)

**Nguyên tắc cơ bản:**

- Người chơi chọn từ 2 đến 5 cặp số (mỗi cặp có 2 chữ số)
- Nhiều trường hợp trúng thưởng khác nhau

**Cách tính tiền đóng:**

- Đá 2 số: mệnh giá × 1
- Đá 3 số: mệnh giá × 3
- Đá 4 số: mệnh giá × 6
- Đá 5 số: mệnh giá × 10

**Tỷ lệ thắng:** Nhiều trường hợp khác nhau, từ 1:12.5 đến 1:3750

**Áp dụng:** Chủ yếu M1

## 3. Object JSON cho các loại cược

## 4. Logic đối soát kết quả

### 4.1 Đầu Đuôi (dd)

- **Logic đối soát**:
  - Nếu chọn đầu đuôi (dd): Kiểm tra số với giải 8 (M1) hoặc giải 7 (M2) cho phần đầu, và 2 số cuối của giải Đặc Biệt cho phần đuôi.
  - Nếu chỉ chọn đầu (dau): Chỉ kiểm tra số với giải 8 (M1) hoặc giải 7 (M2).
  - Nếu chỉ chọn đuôi (duoi): Chỉ kiểm tra số với 2 số cuối của giải Đặc Biệt.

### 4.2 Xỉu Chủ (xc)

- **Logic đối soát**:
  - Nếu chọn xỉu chủ toàn phần (xc): Kiểm tra số với giải 7 (M1) hoặc giải 6 (M2) cho phần đầu, và 3 số cuối của giải Đặc Biệt cho phần đuôi.
  - Nếu chỉ chọn đầu (dau): Chỉ kiểm tra số với giải 7 (M1) hoặc giải 6 (M2).
  - Nếu chỉ chọn đuôi (duoi): Chỉ kiểm tra số với 3 số cuối của giải Đặc Biệt.

### 4.3 Bao Lô N (b2, b3, b4)

- **Logic đối soát**:
  - Kiểm tra N số cuối của tất cả các lô trong các giải (theo số lượng lô tương ứng).
  - Nếu số đặt cược khớp với N số cuối của bất kỳ lô nào, người chơi thắng.

### 4.4 Bao 7 Lô (b7l)

- **Logic đối soát**:
  - Kiểm tra số đặt cược (2, 3 hoặc 4 chữ số) với số cuối tương ứng của 7 lô cụ thể ở M1:
    - Giải tám (1 lô)
    - Giải bảy (1 lô)
    - Giải sáu (3 lô)
    - Giải năm (1 lô)
    - Giải đặc biệt (1 lô)

### 4.5 Bao 8 Lô (b8l)

- **Logic đối soát**:
  - Kiểm tra số đặt cược (2, 3 hoặc 4 chữ số) với số cuối tương ứng của 8 lô cụ thể ở M2:
    - Giải đặc biệt (1 lô)
    - Giải bảy (1 lô)
    - Giải sáu (3 lô)
    - Giải năm (1 lô)
    - Giải tư (1 lô)
    - Giải ba (1 lô)

### 4.6 Nhất To (nt)

- **Logic đối soát**:
  - Kiểm tra số đặt cược với 2 số cuối của giải Nhất ở M2.

### 4.7 Xiên (x)

- **Logic đối soát**:
  - Kiểm tra tất cả các cặp số đặt cược với 2 số cuối của tất cả các lô ở M2.
  - Chỉ khi tất cả các cặp số đều xuất hiện trong kết quả, người chơi thắng.

### 4.8 Đá (da)

- **Logic đối soát**:
  - Kiểm tra các cặp số đặt cược với 2 số cuối của tất cả các lô ở M1.
  - Dựa vào số lượng cặp trúng và cách trúng, áp dụng tỷ lệ thưởng tương ứng.
  - Có nhiều trường hợp thắng khác nhau (như trúng 2 số, trúng 3 số, trúng 2 số + 1 số về 2 lần, v.v.)

## 5. TypeScript Interfaces

```typescript
// Định nghĩa các interfaces cho betTypes
interface Prize {
  prize: string
  match: string
}

interface WinLogicSimple {
  match: string
  prizes: string[]
}

interface WinLogicComplex {
  complex: boolean
  prizes: string[]
}

interface WinLogicVariable {
  prizes: string[]
  match: string
}

interface WinLogicXien {
  allNumbers: boolean
  prizes: string[]
}

interface BetSubtype {
  id: string
  name: string
  payRate: number
  betRateM1?: number
  betRateM2?: number
  count?: number
}

interface DaSubtype extends BetSubtype {
  betRate: number
  payRates: {
    [key: string]: number
  }
}

interface BetType {
  id: string
  name: string
  description: string
  digits: number | string
  region: string
  subtypes?: BetSubtype[] | DaSubtype[]
  payRate?: number
  betRateM1?: number
  betRateM2?: number
  betRate?: number
  payRates?: {
    [key: string]: number
  }
  winLogic: {
    M1?: Prize[] | WinLogicSimple
    M2?: Prize[] | WinLogicSimple
    prize?: string
    match?: string
    prizes?: string[]
    allNumbers?: boolean
    complex?: boolean
    variable?: string
  }
}

// Định nghĩa các interfaces cho numberSelectionMethods
interface ZodiacOption {
  id: string
  name: string
  value: number
  numbers: string[]
}

interface HighLowOption {
  id: string
  name: string
  range: string
  count: number
}

interface OddEvenOption {
  id: string
  name: string
  formula: string
  count: number
}

interface ReverseNumberSubtype {
  id: string
  name: string
  digits: number
  maxPermutations: number
}

interface NumberSequenceSubtype {
  id: string
  name: string
  description: string
  inputType?: string
  inputRange?: string
  fixed?: boolean
  numbers?: string[]
  outputCount: number
}

interface NumberSelectionMethod {
  id: string
  name: string
  description: string
  options?: ZodiacOption[] | HighLowOption[] | OddEvenOption[]
  subtypes?: ReverseNumberSubtype[] | NumberSequenceSubtype[]
}

// Interface cho form đặt cược
interface BetFormData {
  userId: string
  username: string
  betDate: Date
  drawDate: Date
  region: 'M1' | 'M2' | 'both'
  province: string
  betType: string
  betSubtype?: string
  betAmount: number
  numbers: string[]
  totalAmount: number
  potentialWin: number
  betId: string
}

// Interface cho kết quả xổ số
interface LotteryResult {
  date: Date
  region: 'M1' | 'M2'
  province: string
  results: {
    [prizeKey: string]: string[]
  }
}

// Interface cho kết quả đối soát
interface BetCheckResult {
  betId: string
  userId: string
  betDate: Date
  drawDate: Date
  betType: string
  betSubtype?: string
  betAmount: number
  numbers: string[]
  totalAmount: number
  winAmount: number
  matchedNumbers: {
    number: string
    matches: {
      prize: string
      matchType: string
      value: string
    }[]
  }[]
  isWin: boolean
}
```

## 6. Utility Functions cho tính toán tiền cược

```typescript
/**
 * Tính tổng tiền đóng cho cược Đầu Đuôi
 * @param betAmount Mệnh giá cược
 * @param subtype Kiểu phụ (dd, dau, duoi)
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateDauDuoiBetAmount(
  betAmount: number,
  subtype: string,
  region: string
): number {
  let total = 0

  if (region === 'M1' || region === 'both') {
    if (subtype === 'dd') total += betAmount * 2
    else total += betAmount
  }

  if (region === 'M2' || region === 'both') {
    if (subtype === 'dd') total += betAmount * 5
    else if (subtype === 'dau') total += betAmount * 4
    else total += betAmount
  }

  return total
}

/**
 * Tính tổng tiền đóng cho cược Xỉu Chủ
 * @param betAmount Mệnh giá cược
 * @param subtype Kiểu phụ (xc, dau, duoi)
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateXiuChuBetAmount(
  betAmount: number,
  subtype: string,
  region: string
): number {
  let total = 0

  if (region === 'M1' || region === 'both') {
    if (subtype === 'xc') total += betAmount * 2
    else total += betAmount
  }

  if (region === 'M2' || region === 'both') {
    if (subtype === 'xc') total += betAmount * 4
    else if (subtype === 'dau') total += betAmount * 3
    else total += betAmount
  }

  return total
}

/**
 * Tính tổng tiền đóng cho cược Bao Lô N
 * @param betAmount Mệnh giá cược
 * @param digits Số chữ số (2, 3, 4)
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateBaoLoBetAmount(
  betAmount: number,
  digits: number,
  region: string
): number {
  const rateM1 = digits === 2 ? 18 : digits === 3 ? 17 : 16
  const rateM2 = digits === 2 ? 27 : digits === 3 ? 23 : 20

  let total = 0

  if (region === 'M1' || region === 'both') {
    total += betAmount * rateM1
  }

  if (region === 'M2' || region === 'both') {
    total += betAmount * rateM2
  }

  return total
}

/**
 * Tính tổng tiền đóng cho cược Bao 7 Lô
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateBao7LoBetAmount(betAmount: number): number {
  return betAmount * 7
}

/**
 * Tính tổng tiền đóng cho cược Bao 8 Lô
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateBao8LoBetAmount(betAmount: number): number {
  return betAmount * 8
}

/**
 * Tính tổng tiền đóng cho cược Nhất To
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateNhatToBetAmount(betAmount: number): number {
  return betAmount
}

/**
 * Tính tổng tiền đóng cho cược Xiên
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateXienBetAmount(betAmount: number): number {
  return betAmount * 27
}

/**
 * Tính tổng tiền đóng cho cược Đá
 * @param betAmount Mệnh giá cược
 * @param count Số lượng cặp số (2, 3, 4, 5)
 * @returns Tổng tiền đóng
 */
export function calculateDaBetAmount(betAmount: number, count: number): number {
  const rates: Record<number, number> = {
    2: 1,
    3: 3,
    4: 6,
    5: 10,
  }

  return betAmount * rates[count]
}

/**
 * Tính tổng tiền thắng tiềm năng
 * @param betAmount Mệnh giá cược
 * @param payRate Tỷ lệ thưởng
 * @returns Tổng tiền thắng tiềm năng
 */
export function calculatePotentialWinAmount(
  betAmount: number,
  payRate: number
): number {
  return betAmount * payRate
}

/**
 * Tính tổng tiền đóng cho tổ hợp số
 * @param betAmount Mệnh giá cược
 * @param numberCount Số lượng số trong tổ hợp
 * @param betType Loại cược
 * @param betSubtype Kiểu phụ của loại cược
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateCombinationBetAmount(
  betAmount: number,
  numberCount: number,
  betType: string,
  betSubtype: string,
  region: string
): number {
  let unitBetAmount = 0

  if (betType === 'dd') {
    unitBetAmount = calculateDauDuoiBetAmount(betAmount, betSubtype, region)
  } else if (betType === 'xc') {
    unitBetAmount = calculateXiuChuBetAmount(betAmount, betSubtype, region)
  } else if (['b2', 'b3', 'b4'].includes(betType)) {
    const digits = parseInt(betType.charAt(1))
    unitBetAmount = calculateBaoLoBetAmount(betAmount, digits, region)
  } else if (betType === 'b7l') {
    unitBetAmount = calculateBao7LoBetAmount(betAmount)
  } else if (betType === 'b8l') {
    unitBetAmount = calculateBao8LoBetAmount(betAmount)
  } else if (betType === 'nt') {
    unitBetAmount = calculateNhatToBetAmount(betAmount)
  } else if (betType === 'x') {
    unitBetAmount = calculateXienBetAmount(betAmount)
  } else if (betType === 'da') {
    const count = parseInt(betSubtype.charAt(2))
    unitBetAmount = calculateDaBetAmount(betAmount, count)
  }

  return unitBetAmount * numberCount
}

/**
 * Kiểm tra số có hợp lệ với loại cược không
 * @param number Số cược
 * @param betType Loại cược
 * @returns true nếu hợp lệ, false nếu không
 */
export function isValidNumberForBetType(
  number: string,
  betType: string
): boolean {
  if (['dd', 'nt', 'b2'].includes(betType)) {
    // Cần 2 chữ số
    return /^\d{2}$/.test(number)
  } else if (['xc', 'b3'].includes(betType)) {
    // Cần 3 chữ số
    return /^\d{3}$/.test(number)
  } else if (betType === 'b4') {
    // Cần 4 chữ số
    return /^\d{4}$/.test(number)
  } else if (['b7l', 'b8l'].includes(betType)) {
    // Có thể là 2, 3 hoặc 4 chữ số
    return /^\d{2,4}$/.test(number)
  } else if (['x', 'da'].includes(betType)) {
    // Cần 2 chữ số cho mỗi cặp, nhưng đây là một trường hợp phức tạp hơn
    // cần xem xét trong context của việc xử lý nhiều cặp số
    return /^\d{2}$/.test(number)
  }

  return false
}

/**
 * Lấy tỷ lệ thắng cho loại cược
 * @param betType Loại cược
 * @param betSubtype Kiểu phụ (nếu có)
 * @param digits Số chữ số (cho b7l/b8l)
 * @returns Tỷ lệ thắng
 */
export function getPayRate(
  betType: string,
  betSubtype?: string,
  digits?: number
): number {
  if (betType === 'dd' || betType === 'nt' || betType === 'b2') {
    return 75
  } else if (betType === 'xc' || betType === 'b3') {
    return 650
  } else if (betType === 'b4') {
    return 5500
  } else if (betType === 'b7l' || betType === 'b8l') {
    if (digits === 2) return 75
    if (digits === 3) return 650
    if (digits === 4) return 5500
    return 0
  } else if (betType === 'x') {
    if (betSubtype === 'x2') return 75
    if (betSubtype === 'x3') return 40
    if (betSubtype === 'x4') return 250
    return 0
  } else if (betType === 'da') {
    // Đá có nhiều tỷ lệ thắng khác nhau tùy trường hợp
    // Trả về tỷ lệ thắng cơ bản nhất
    if (betSubtype === 'da2') return 12.5
    if (betSubtype === 'da3') return 25 // Lowest rate for da3
    if (betSubtype === 'da4') return 75 // Lowest rate for da4
    if (betSubtype === 'da5') return 500 // Lowest rate for da5
    return 0
  }

  return 0
}

// ===== Các hàm tạo số tự động =====

/**
 * Tạo tất cả các hoán vị có thể có của một số
 * @param number Số gốc
 * @returns Mảng chứa tất cả các hoán vị
 */
export function generatePermutations(number: string): string[] {
  // Hàm đệ quy để tạo hoán vị
  function permute(arr: string[]): string[][] {
    if (arr.length <= 1) return [arr]

    const result: string[][] = []

    for (let i = 0; i < arr.length; i++) {
      const current = arr[i]
      const remaining = [...arr.slice(0, i), ...arr.slice(i + 1)]
      const remainingPermutations = permute(remaining)

      for (const perm of remainingPermutations) {
        result.push([current, ...perm])
      }
    }

    return result
  }

  // Tạo mảng từ chuỗi số
  const digits = number.split('')

  // Tạo hoán vị
  const permutations = permute(digits)

  // Chuyển đổi mảng 2D thành mảng chuỗi và loại bỏ số trùng lặp
  return Array.from(new Set(permutations.map((perm) => perm.join(''))))
}

/**
 * Tạo số theo 12 con giáp
 * @param zodiac Con giáp (0-11)
 * @returns Mảng các số thuộc con giáp
 */
export function generateZodiacNumbers(zodiac: number): string[] {
  const numbers: string[] = []

  for (let i = 0; i < 100; i++) {
    if (i % 12 === zodiac) {
      numbers.push(i.toString().padStart(2, '0'))
    }
  }

  return numbers
}

/**
 * Tạo số theo Tài hoặc Xỉu
 * @param isHigh true nếu là Tài, false nếu là Xỉu
 * @returns Mảng các số thuộc Tài hoặc Xỉu
 */
export function generateHighLowNumbers(isHigh: boolean): string[] {
  const numbers: string[] = []

  for (let i = 0; i < 100; i++) {
    const number = i.toString().padStart(2, '0')

    if (isHigh && i >= 50) {
      numbers.push(number)
    } else if (!isHigh && i < 50) {
      numbers.push(number)
    }
  }

  return numbers
}

/**
 * Tạo số theo Chẵn hoặc Lẻ
 * @param isEven true nếu là Chẵn, false nếu là Lẻ
 * @returns Mảng các số Chẵn hoặc Lẻ
 */
export function generateOddEvenNumbers(isEven: boolean): string[] {
  const numbers: string[] = []

  for (let i = 0; i < 100; i++) {
    const number = i.toString().padStart(2, '0')

    if ((isEven && i % 2 === 0) || (!isEven && i % 2 === 1)) {
      numbers.push(number)
    }
  }

  return numbers
}

/**
 * Tạo số theo kiểu Kéo chục
 * @param tens Chữ số hàng chục (0-9)
 * @returns Mảng các số có cùng hàng chục
 */
export function generateTenthsNumbers(tens: number): string[] {
  const numbers: string[] = []

  for (let i = 0; i < 10; i++) {
    numbers.push(`${tens}${i}`)
  }

  return numbers
}

/**
 * Tạo số theo kiểu Kéo đơn vị
 * @param units Chữ số hàng đơn vị (0-9)
 * @returns Mảng các số có cùng hàng đơn vị
 */
export function generateUnitsNumbers(units: number): string[] {
  const numbers: string[] = []

  for (let i = 0; i < 10; i++) {
    numbers.push(`${i}${units}`)
  }

  return numbers
}

/**
 * Tạo các số đôi (Kéo Xỉu Chủ nhị)
 * @returns Mảng các số có 2 chữ số giống nhau
 */
export function generateDoubleNumbers(): string[] {
  return ['11', '22', '33', '44', '55', '66', '77', '88', '99']
}

/**
 * Tạo các số ba (Kéo Xỉu Chủ tam)
 * @returns Mảng các số có 3 chữ số giống nhau
 */
export function generateTripleNumbers(): string[] {
  return ['111', '222', '333', '444', '555', '666', '777', '888', '999']
}

/**
 * Tạo các số liên tiếp tăng dần (Kéo xỉu lũy tiến)
 * @returns Mảng các số có 3 chữ số liên tiếp tăng dần
 */
export function generateSequentialNumbers(): string[] {
  return ['123', '234', '345', '456', '567', '678', '789']
}
```
