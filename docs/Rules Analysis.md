# Phân tích Quy tắc Cá cược Xổ số

## 1. Danh sách các loại cược

Từ tài liệu, tôi xác định được 8 loại cược chính:

1. **Đầu Đuôi (dd)** - Cược vào số ở giải 8 (M1)/giải 7 (M2) và 2 số cuối giải Đặc biệt
2. **Xỉu Chủ (xc)** - Cược vào số ở giải 7 (M1)/giải 6 (M2) và 3 số cuối giải Đặc biệt
3. **Bao Lô N (b2, b3, b4)** - Cược khớp với N số cuối của bất kỳ lô nào trong các giải
4. **Bao 7 Lô (b7l)** - Cược khớp với số cuối của 7 lô cụ thể ở M1
5. **Bao 8 Lô (b8l)** - Cược khớp với số cuối của 8 lô cụ thể ở M2
6. **Nhất To (nt)** - Cược khớp với 2 số cuối của giải Nhất ở M2
7. **Xiên (x)** - Cược khi tất cả các cặp số xuất hiện trong kết quả (M2)
8. **Đá (da)** - Cược phức tạp với nhiều trường hợp trúng (M1)

## 2. Tóm tắt các loại cược

### 2.1 Đầu Đuôi (dd)

**Nguyên tắc cơ bản:**

- Đặt số có 2 chữ số (00-99)
- 3 cách chơi: đầu đuôi (dd), chỉ đầu (dau), chỉ đuôi (duoi)

**Cách tính tiền đóng:**

- Đầu đuôi (dd): M1 (mệnh giá × 2), M2 (mệnh giá × 5)
- Chỉ đầu (dau): M1 (mệnh giá × 1), M2 (mệnh giá × 4)
- Chỉ đuôi (duoi): M1 và M2 (mệnh giá × 1)

**Tỷ lệ thắng:** 1 ăn 75 (1:75)

**Áp dụng:** Cả M1 và M2

### 2.2 Xỉu Chủ (xc)

**Nguyên tắc cơ bản:**

- Đặt số có 3 chữ số (000-999)
- 3 cách chơi: xỉu chủ toàn phần (xc), chỉ đầu (dau), chỉ đuôi (duoi)

**Cách tính tiền đóng:**

- Xỉu chủ toàn phần (xc): M1 (mệnh giá × 2), M2 (mệnh giá × 4)
- Chỉ đầu (dau): M1 (mệnh giá × 1), M2 (mệnh giá × 3)
- Chỉ đuôi (duoi): M1 và M2 (mệnh giá × 1)

**Tỷ lệ thắng:** 1 ăn 650 (1:650)

**Áp dụng:** Cả M1 và M2

### 2.3 Bao Lô N (b2, b3, b4)

**Nguyên tắc cơ bản:**

- Đặt số có N chữ số (N = 2, 3 hoặc 4)
- Số khớp với N số cuối của bất kỳ lô nào

**Cách tính tiền đóng:**

- Bao Lô 2: M1 (mệnh giá × 18), M2 (mệnh giá × 27)
- Bao Lô 3: M1 (mệnh giá × 17), M2 (mệnh giá × 23)
- Bao Lô 4: M1 (mệnh giá × 16), M2 (mệnh giá × 20)

**Tỷ lệ thắng:**

- Bao Lô 2: 1:75
- Bao Lô 3: 1:650
- Bao Lô 4: 1:5500

**Áp dụng:** Cả M1 và M2

### 2.4 Bao 7 Lô (b7l)

**Nguyên tắc cơ bản:**

- Đặt số có 2, 3 hoặc 4 chữ số
- Số khớp với số cuối của 7 lô cụ thể ở M1

**Cách tính tiền đóng:** M1 (mệnh giá × 7)

**Tỷ lệ thắng:**

- 2 chữ số: 1:75
- 3 chữ số: 1:650
- 4 chữ số: 1:5500

**Áp dụng:** Chủ yếu M1

### 2.5 Bao 8 Lô (b8l)

**Nguyên tắc cơ bản:**

- Đặt số có 2, 3 hoặc 4 chữ số
- Số khớp với số cuối của 8 lô cụ thể ở M2

**Cách tính tiền đóng:** M2 (mệnh giá × 8)

**Tỷ lệ thắng:** Giống Bao 7 Lô

**Áp dụng:** Chủ yếu M2

### 2.6 Nhất To (nt)

**Nguyên tắc cơ bản:**

- Đặt số có 2 chữ số
- Số khớp với 2 số cuối của giải Nhất ở M2

**Cách tính tiền đóng:** M2 (mệnh giá × 1)

**Tỷ lệ thắng:** 1:75

**Áp dụng:** Chủ yếu M2

### 2.7 Xiên (x)

**Nguyên tắc cơ bản:**

- Chọn 2, 3 hoặc 4 cặp số (mỗi cặp 2 chữ số)
- Thắng khi tất cả các cặp số xuất hiện trong kết quả

**Cách tính tiền đóng:** M2 (mệnh giá × 27)

**Tỷ lệ thắng:**

- Xiên 2: 1:75
- Xiên 3: 1:40
- Xiên 4: 1:250

**Áp dụng:** Chủ yếu M2

### 2.8 Đá (da)

**Nguyên tắc cơ bản:**

- Chọn từ 2 đến 5 cặp số (mỗi cặp 2 chữ số)
- Nhiều trường hợp trúng thưởng khác nhau

**Cách tính tiền đóng:**

- Đá 2 số: mệnh giá × 1
- Đá 3 số: mệnh giá × 3
- Đá 4 số: mệnh giá × 6
- Đá 5 số: mệnh giá × 10

**Tỷ lệ thắng:** Từ 1:12.5 đến 1:3750 (theo nhiều trường hợp)

**Áp dụng:** Chủ yếu M1

## 3. Object JSON cho các loại cược

## 4. Logic đối soát kết quả

### 4.1 Đầu Đuôi (dd)

- **Đầu đuôi (dd)**: Kiểm tra khớp với giải 8 (M1)/giải 7 (M2) cho đầu, và 2 số cuối giải Đặc Biệt cho đuôi
- **Chỉ đầu (dau)**: Chỉ kiểm tra khớp với giải 8 (M1)/giải 7 (M2)
- **Chỉ đuôi (duoi)**: Chỉ kiểm tra khớp với 2 số cuối giải Đặc Biệt

### 4.2 Xỉu Chủ (xc)

- **Xỉu chủ toàn phần (xc)**: Kiểm tra khớp với giải 7 (M1)/giải 6 (M2) cho đầu, và 3 số cuối giải Đặc Biệt cho đuôi
- **Chỉ đầu (dau)**: Chỉ kiểm tra khớp với giải 7 (M1)/giải 6 (M2)
- **Chỉ đuôi (duoi)**: Chỉ kiểm tra khớp với 3 số cuối giải Đặc Biệt

### 4.3 Bao Lô N (b2, b3, b4)

- Kiểm tra N số cuối (2, 3 hoặc 4) của tất cả các lô trong các giải
- Nếu số cược khớp với N số cuối của bất kỳ lô nào, người chơi thắng

### 4.4 Bao 7 Lô (b7l)

- Kiểm tra số cược (2, 3 hoặc 4 chữ số) với 7 lô cụ thể ở M1:
  - Giải tám (1 lô)
  - Giải bảy (1 lô)
  - Giải sáu (3 lô)
  - Giải năm (1 lô)
  - Giải đặc biệt (1 lô)

### 4.5 Bao 8 Lô (b8l)

- Kiểm tra số cược (2, 3 hoặc 4 chữ số) với 8 lô cụ thể ở M2:
  - Giải đặc biệt (1 lô)
  - Giải bảy (1 lô)
  - Giải sáu (3 lô)
  - Giải năm (1 lô)
  - Giải tư (1 lô)
  - Giải ba (1 lô)

### 4.6 Nhất To (nt)

- Kiểm tra số cược với 2 số cuối của giải Nhất ở M2

### 4.7 Xiên (x)

- Kiểm tra tất cả các cặp số đặt cược với kết quả
- Chỉ khi tất cả các cặp số đều xuất hiện trong kết quả, người chơi thắng

### 4.8 Đá (da)

- Kiểm tra số cặp số trúng và cách trúng
- Áp dụng tỷ lệ thưởng tương ứng với từng trường hợp trúng

## 5. TypeScript Interfaces

```typescript
// Định nghĩa các interfaces cho betTypes
interface Prize {
  prize: string;
  match: string;
}

interface WinLogicSimple {
  match: string;
  prizes: string[];
}

interface WinLogicComplex {
  complex: boolean;
  prizes: string[];
}

interface WinLogicVariable {
  prizes: string[];
  match: string;
}

interface WinLogicXien {
  allNumbers: boolean;
  prizes: string[];
}

interface BetSubtype {
  id: string;
  name: string;
  payRate: number;
  betRateM1?: number;
  betRateM2?: number;
  count?: number;
}

interface DaSubtype extends BetSubtype {
  betRate: number;
  payRates: {
    [key: string]: number;
  };
}

interface BetType {
  id: string;
  name: string;
  description: string;
  digits: number | string;
  region: string;
  subtypes?: BetSubtype[] | DaSubtype[];
  payRate?: number;
  betRateM1?: number;
  betRateM2?: number;
  betRate?: number;
  payRates?: {
    [key: string]: number;
  };
  winLogic: {
    M1?: Prize[] | WinLogicSimple;
    M2?: Prize[] | WinLogicSimple;
    prize?: string;
    match?: string;
    prizes?: string[];
    allNumbers?: boolean;
    complex?: boolean;
    variable?: string;
  };
}

// Định nghĩa các interfaces cho numberSelectionMethods
interface ZodiacOption {
  id: string;
  name: string;
  value: number;
  numbers: string[];
}

interface HighLowOption {
  id: string;
  name: string;
  range: string;
  count: number;
}

interface OddEvenOption {
  id: string;
  name: string;
  formula: string;
  count: number;
}

interface ReverseNumberSubtype {
  id: string;
  name: string;
  digits: number;
  maxPermutations: number;
}

interface NumberSequenceSubtype {
  id: string;
  name: string;
  description: string;
  inputType?: string;
  inputRange?: string;
  fixed?: boolean;
  numbers?: string[];
  outputCount: number;
}

interface NumberSelectionMethod {
  id: string;
  name: string;
  description: string;
  options?: ZodiacOption[] | HighLowOption[] | OddEvenOption[];
  subtypes?: ReverseNumberSubtype[] | NumberSequenceSubtype[];
}

// Interface cho form đặt cược
interface BetFormData {
  userId: string;
  username: string;
  betDate: Date;
  drawDate: Date;
  region: 'M1' | 'M2' | 'both';
  province: string;
  betType: string;
  betSubtype?: string;
  betAmount: number;
  numbers: string[];
  totalAmount: number;
  potentialWin: number;
  betId: string;
}

// Interface cho kết quả xổ số
interface LotteryResult {
  date: Date;
  region: 'M1' | 'M2';
  province: string;
  results: {
    [prizeKey: string]: string[];
  };
}

// Interface cho kết quả đối soát
interface BetCheckResult {
  betId: string;
  userId: string;
  betDate: Date;
  drawDate: Date;
  betType: string;
  betSubtype?: string;
  betAmount: number;
  numbers: string[];
  totalAmount: number;
  winAmount: number;
  matchedNumbers: {
    number: string;
    matches: {
      prize: string;
      matchType: string;
      value: string;
    }[];
  }[];
  isWin: boolean;
}

// Interface cho metadata của danh sách tỉnh
interface LotteryProvincesMetadata {
  version: string;
  nguon: string;
  ngayLayDuLieu: string;
  tongSoMien: number;
  tongSoNgay: number;
}

// Interface cho thông tin tỉnh
interface ProvinceInfo {
  tinh: string;
  maTinh?: string;
  ngay: string;
  thu: string;
  mien: string;
}

// Interface cho danh sách các tỉnh theo ngày trong tuần
interface DayProvinces {
  'mien-bac': ProvinceInfo[];
  'mien-trung': ProvinceInfo[];
  'mien-nam': ProvinceInfo[];
}

// Interface cho dữ liệu chính của danh sách tỉnh
interface LotteryProvincesData {
  'thu-hai': DayProvinces;
  'thu-ba': DayProvinces;
  'thu-tu': DayProvinces;
  'thu-nam': DayProvinces;
  'thu-sau': DayProvinces;
  'thu-bay': DayProvinces;
  'chu-nhat': DayProvinces;
}

// Interface tổng quát cho cả file danh sách tỉnh
interface LotteryProvinces {
  metadata: LotteryProvincesMetadata;
  duLieu: LotteryProvincesData;
}
```

## 6. Utility Functions cho tính toán tiền cược và xử lý số

```typescript
/**
 * Tính tổng tiền đóng cho cược Đầu Đuôi
 * @param betAmount Mệnh giá cược
 * @param subtype Kiểu phụ (dd, dau, duoi)
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateDauDuoiBetAmount(
  betAmount: number,
  subtype: string,
  region: 'M1' | 'M2' | 'both'
): number {
  let total = 0;

  if (region === 'M1' || region === 'both') {
    if (subtype === 'dd') total += betAmount * 2;
    else total += betAmount;
  }

  if (region === 'M2' || region === 'both') {
    if (subtype === 'dd') total += betAmount * 5;
    else if (subtype === 'dau') total += betAmount * 4;
    else total += betAmount;
  }

  return total;
}

/**
 * Tính tổng tiền đóng cho cược Xỉu Chủ
 * @param betAmount Mệnh giá cược
 * @param subtype Kiểu phụ (xc, dau, duoi)
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateXiuChuBetAmount(
  betAmount: number,
  subtype: string,
  region: 'M1' | 'M2' | 'both'
): number {
  let total = 0;

  if (region === 'M1' || region === 'both') {
    if (subtype === 'xc') total += betAmount * 2;
    else total += betAmount;
  }

  if (region === 'M2' || region === 'both') {
    if (subtype === 'xc') total += betAmount * 4;
    else if (subtype === 'dau') total += betAmount * 3;
    else total += betAmount;
  }

  return total;
}

/**
 * Tính tổng tiền đóng cho cược Bao Lô N
 * @param betAmount Mệnh giá cược
 * @param digits Số chữ số (2, 3, 4)
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateBaoLoBetAmount(
  betAmount: number,
  digits: number,
  region: 'M1' | 'M2' | 'both'
): number {
  const rateM1 = digits === 2 ? 18 : digits === 3 ? 17 : 16;
  const rateM2 = digits === 2 ? 27 : digits === 3 ? 23 : 20;

  let total = 0;

  if (region === 'M1' || region === 'both') {
    total += betAmount * rateM1;
  }

  if (region === 'M2' || region === 'both') {
    total += betAmount * rateM2;
  }

  return total;
}

/**
 * Tính tổng tiền đóng cho cược Bao 7 Lô
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateBao7LoBetAmount(betAmount: number): number {
  return betAmount * 7;
}

/**
 * Tính tổng tiền đóng cho cược Bao 8 Lô
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateBao8LoBetAmount(betAmount: number): number {
  return betAmount * 8;
}

/**
 * Tính tổng tiền đóng cho cược Nhất To
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateNhatToBetAmount(betAmount: number): number {
  return betAmount;
}

/**
 * Tính tổng tiền đóng cho cược Xiên
 * @param betAmount Mệnh giá cược
 * @returns Tổng tiền đóng
 */
export function calculateXienBetAmount(betAmount: number): number {
  return betAmount * 27;
}

/**
 * Tính tổng tiền đóng cho cược Đá
 * @param betAmount Mệnh giá cược
 * @param count Số lượng cặp số (2, 3, 4, 5)
 * @returns Tổng tiền đóng
 */
export function calculateDaBetAmount(betAmount: number, count: number): number {
  const rates: Record<number, number> = {
    2: 1,
    3: 3,
    4: 6,
    5: 10,
  };

  return betAmount * rates[count];
}

/**
 * Tính tổng tiền thắng tiềm năng
 * @param betAmount Mệnh giá cược
 * @param payRate Tỷ lệ thưởng
 * @returns Tổng tiền thắng tiềm năng
 */
export function calculatePotentialWinAmount(betAmount: number, payRate: number): number {
  return betAmount * payRate;
}

/**
 * Tính tổng tiền đóng cho tổ hợp số
 * @param betAmount Mệnh giá cược
 * @param numberCount Số lượng số trong tổ hợp
 * @param betType Loại cược
 * @param betSubtype Kiểu phụ của loại cược
 * @param region Miền (M1, M2, hoặc both)
 * @returns Tổng tiền đóng
 */
export function calculateCombinationBetAmount(
  betAmount: number,
  numberCount: number,
  betType: string,
  betSubtype: string,
  region: 'M1' | 'M2' | 'both'
): number {
  let unitBetAmount = 0;

  if (betType === 'dd') {
    unitBetAmount = calculateDauDuoiBetAmount(betAmount, betSubtype, region);
  } else if (betType === 'xc') {
    unitBetAmount = calculateXiuChuBetAmount(betAmount, betSubtype, region);
  } else if (['b2', 'b3', 'b4'].includes(betType)) {
    const digits = parseInt(betType.charAt(1));
    unitBetAmount = calculateBaoLoBetAmount(betAmount, digits, region);
  } else if (betType === 'b7l') {
    unitBetAmount = calculateBao7LoBetAmount(betAmount);
  } else if (betType === 'b8l') {
    unitBetAmount = calculateBao8LoBetAmount(betAmount);
  } else if (betType === 'nt') {
    unitBetAmount = calculateNhatToBetAmount(betAmount);
  } else if (betType === 'x') {
    unitBetAmount = calculateXienBetAmount(betAmount);
  } else if (betType === 'da') {
    const count = parseInt(betSubtype.charAt(2));
    unitBetAmount = calculateDaBetAmount(betAmount, count);
  }

  return unitBetAmount * numberCount;
}

/**
 * Kiểm tra số có hợp lệ với loại cược không
 * @param number Số cược
 * @param betType Loại cược
 * @returns true nếu hợp lệ, false nếu không
 */
export function isValidNumberForBetType(number: string, betType: string): boolean {
  if (['dd', 'nt', 'b2'].includes(betType)) {
    // Cần 2 chữ số
    return /^\d{2}$/.test(number);
  } else if (['xc', 'b3'].includes(betType)) {
    // Cần 3 chữ số
    return /^\d{3}$/.test(number);
  } else if (betType === 'b4') {
    // Cần 4 chữ số
    return /^\d{4}$/.test(number);
  } else if (['b7l', 'b8l'].includes(betType)) {
    // Có thể là 2, 3 hoặc 4 chữ số
    return /^\d{2,4}$/.test(number);
  } else if (['x', 'da'].includes(betType)) {
    // Cần 2 chữ số cho mỗi cặp
    return /^\d{2}$/.test(number);
  }

  return false;
}

/**
 * Lấy tỷ lệ thắng cho loại cược
 * @param betType Loại cược
 * @param betSubtype Kiểu phụ (nếu có)
 * @param digits Số chữ số (cho b7l/b8l)
 * @returns Tỷ lệ thắng
 */
export function getPayRate(betType: string, betSubtype?: string, digits?: number): number {
  if (betType === 'dd' || betType === 'nt' || betType === 'b2') {
    return 75;
  } else if (betType === 'xc' || betType === 'b3') {
    return 650;
  } else if (betType === 'b4') {
    return 5500;
  } else if (betType === 'b7l' || betType === 'b8l') {
    if (digits === 2) return 75;
    if (digits === 3) return 650;
    if (digits === 4) return 5500;
    return 0;
  } else if (betType === 'x') {
    if (betSubtype === 'x2') return 75;
    if (betSubtype === 'x3') return 40;
    if (betSubtype === 'x4') return 250;
    return 0;
  } else if (betType === 'da') {
    // Đá có nhiều tỷ lệ thắng khác nhau tùy trường hợp
    // Trả về tỷ lệ thắng cơ bản nhất
    if (betSubtype === 'da2') return 12.5;
    if (betSubtype === 'da3') return 25; // Lowest rate for da3
    if (betSubtype === 'da4') return 75; // Lowest rate for da4
    if (betSubtype === 'da5') return 500; // Lowest rate for da5
    return 0;
  }

  return 0;
}

// ===== Các hàm tạo số tự động =====

/**
 * Tạo tất cả các hoán vị có thể có của một số
 * @param number Số gốc
 * @returns Mảng chứa tất cả các hoán vị
 */
export function generatePermutations(number: string): string[] {
  // Hàm đệ quy để tạo hoán vị
  function permute(arr: string[]): string[][] {
    if (arr.length <= 1) return [arr];

    const result: string[][] = [];

    for (let i = 0; i < arr.length; i++) {
      const current = arr[i];
      const remaining = [...arr.slice(0, i), ...arr.slice(i + 1)];
      const remainingPermutations = permute(remaining);

      for (const perm of remainingPermutations) {
        result.push([current, ...perm]);
      }
    }

    return result;
  }

  // Tạo mảng từ chuỗi số
  const digits = number.split('');

  // Tạo hoán vị
  const permutations = permute(digits);

  // Chuyển đổi mảng 2D thành mảng chuỗi và loại bỏ số trùng lặp
  return Array.from(new Set(permutations.map((perm) => perm.join(''))));
}

/**
 * Tạo số theo 12 con giáp
 * @param zodiac Con giáp (0-11)
 * @returns Mảng các số thuộc con giáp
 */
export function generateZodiacNumbers(zodiac: number): string[] {
  const numbers: string[] = [];

  for (let i = 0; i < 100; i++) {
    if (i % 12 === zodiac) {
      numbers.push(i.toString().padStart(2, '0'));
    }
  }

  return numbers;
}

/**
 * Tạo số theo Tài hoặc Xỉu
 * @param isHigh true nếu là Tài, false nếu là Xỉu
 * @returns Mảng các số thuộc Tài hoặc Xỉu
 */
export function generateHighLowNumbers(isHigh: boolean): string[] {
  const numbers: string[] = [];

  for (let i = 0; i < 100; i++) {
    const number = i.toString().padStart(2, '0');

    if (isHigh && i >= 50) {
      numbers.push(number);
    } else if (!isHigh && i < 50) {
      numbers.push(number);
    }
  }

  return numbers;
}

/**
 * Tạo số theo Chẵn hoặc Lẻ
 * @param isEven true nếu là Chẵn, false nếu là Lẻ
 * @returns Mảng các số Chẵn hoặc Lẻ
 */
export function generateOddEvenNumbers(isEven: boolean): string[] {
  const numbers: string[] = [];

  for (let i = 0; i < 100; i++) {
    const number = i.toString().padStart(2, '0');

    if ((isEven && i % 2 === 0) || (!isEven && i % 2 === 1)) {
      numbers.push(number);
    }
  }

  return numbers;
}

/**
 * Tạo số theo kiểu Kéo chục
 * @param tens Chữ số hàng chục (0-9)
 * @returns Mảng các số có cùng hàng chục
 */
export function generateTenthsNumbers(tens: number): string[] {
  const numbers: string[] = [];

  for (let i = 0; i < 10; i++) {
    numbers.push(`${tens}${i}`);
  }

  return numbers;
}

/**
 * Tạo số theo kiểu Kéo đơn vị
 * @param units Chữ số hàng đơn vị (0-9)
 * @returns Mảng các số có cùng hàng đơn vị
 */
export function generateUnitsNumbers(units: number): string[] {
  const numbers: string[] = [];

  for (let i = 0; i < 10; i++) {
    numbers.push(`${i}${units}`);
  }

  return numbers;
}

/**
 * Tạo các số đôi (Kéo Xỉu Chủ nhị)
 * @returns Mảng các số có 2 chữ số giống nhau
 */
export function generateDoubleNumbers(): string[] {
  return ['11', '22', '33', '44', '55', '66', '77', '88', '99'];
}

/**
 * Tạo các số ba (Kéo Xỉu Chủ tam)
 * @returns Mảng các số có 3 chữ số giống nhau
 */
export function generateTripleNumbers(): string[] {
  return ['111', '222', '333', '444', '555', '666', '777', '888', '999'];
}

/**
 * Tạo các số liên tiếp tăng dần (Kéo xỉu lũy tiến)
 * @returns Mảng các số có 3 chữ số liên tiếp tăng dần
 */
export function generateSequentialNumbers(): string[] {
  return ['123', '234', '345', '456', '567', '678', '789'];
}

/**
 * Chuyển đổi đơn vị thắng từ dạng string về dạng số
 * @param rate string biểu diễn đơn vị thắng, ví dụ: "1:75"
 * @returns số chỉ đơn vị thắng, ví dụ: 75
 */
export function parsePayRate(rate: string): number {
  const parts = rate.split(':');
  if (parts.length === 2) {
    return parseFloat(parts[1]);
  }
  return 0;
}

/**
 * Tính tiền thắng thực tế cho cược Đá
 * @param betAmount Mệnh giá cược
 * @param betSubtype Loại Đá (da2, da3, da4, da5)
 * @param winType Loại thắng (các key trong payRates)
 * @returns Tiền thắng thực tế
 */
export function calculateDaWinAmount(
  betAmount: number,
  betSubtype: string,
  winType: string
): number {
  // Định nghĩa tỷ lệ thắng cho các loại Đá
  const payRates: Record<string, Record<string, number>> = {
    da2: {
      '2': 12.5,
    },
    da3: {
      all3: 37.5,
      '3+1x3': 112.5,
      '3+1x2': 75,
      '2+1x2': 43.75,
      '2': 25,
    },
    da4: {
      all4: 250,
      '3+1x3': 750,
      '3+1x2': 500,
      '2+2x2': 150,
      '2+1x2': 75,
    },
    da5: {
      all5: 1250,
      '4+1x3': 3750,
      '4+1x2': 2500,
      '3+2x2': 750,
      '3+1x2': 500,
    },
  };

  // Nếu có định nghĩa tỷ lệ cho loại thắng cụ thể
  if (payRates[betSubtype] && payRates[betSubtype][winType]) {
    return betAmount * payRates[betSubtype][winType];
  }

  return 0;
}
```

## 7. JSON mẫu cho cấu trúc dữ liệu đài xổ số theo ngày

```typescript
/**
 * Functions định dạng và xử lý dữ liệu của các đài xổ số theo ngày
 */

import { LotteryProvinces, DayProvinces, ProvinceInfo } from './types';

/**
 * Chuyển đổi định dạng ngày từ YYYY-MM-DD sang DD/MM/YYYY
 */
export function formatDateDDMMYYYY(dateStr: string): string {
  const date = new Date(dateStr);
  const day = date.getDate().toString().padStart(2, '0');
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

/**
 * Lấy tên ngày trong tuần từ một ngày cụ thể
 */
export function getDayOfWeekKey(date: Date): string {
  const days = ['chu-nhat', 'thu-hai', 'thu-ba', 'thu-tu', 'thu-nam', 'thu-sau', 'thu-bay'];
  return days[date.getDay()];
}

/**
 * Lấy danh sách các tỉnh theo ngày
 */
export function getProvincesByDate(lotteryData: LotteryProvinces, date: Date): DayProvinces | null {
  const dayKey = getDayOfWeekKey(date);
  return lotteryData.duLieu[dayKey as keyof typeof lotteryData.duLieu] || null;
}

/**
 * Lấy danh sách các tỉnh theo miền và ngày
 */
export function getProvincesByRegionAndDate(
  lotteryData: LotteryProvinces,
  region: 'mien-bac' | 'mien-trung' | 'mien-nam',
  date: Date
): ProvinceInfo[] {
  const provinces = getProvincesByDate(lotteryData, date);
  if (!provinces) return [];
  return provinces[region] || [];
}

/**
 * Chuyển từ key miền sang tên hiển thị
 */
export function getRegionDisplayName(region: string): string {
  const regionMap: Record<string, string> = {
    'mien-bac': 'Miền Bắc',
    'mien-trung': 'Miền Trung',
    'mien-nam': 'Miền Nam',
  };
  return regionMap[region] || region;
}

/**
 * Chuyển từ key ngày sang tên hiển thị
 */
export function getDayDisplayName(day: string): string {
  const dayMap: Record<string, string> = {
    'thu-hai': 'Thứ Hai',
    'thu-ba': 'Thứ Ba',
    'thu-tu': 'Thứ Tư',
    'thu-nam': 'Thứ Năm',
    'thu-sau': 'Thứ Sáu',
    'thu-bay': 'Thứ Bảy',
    'chu-nhat': 'Chủ Nhật',
  };
  return dayMap[day] || day;
}

/**
 * Chuyển từ tên miền sang mã miền (M1/M2)
 */
export function getRegionCode(region: string): 'M1' | 'M2' | null {
  if (region === 'mien-bac') return 'M2';
  if (region === 'mien-trung' || region === 'mien-nam') return 'M1';
  return null;
}

/**
 * Tạo mẫu dữ liệu kết quả xổ số cho một tỉnh
 */
export function createEmptyResultTemplate(region: 'M1' | 'M2'): Record<string, string[]> {
  if (region === 'M1') {
    return {
      ĐB: ['000000'],
      '1': ['00000'],
      '2': ['00000'],
      '3': ['00000', '00000'],
      '4': ['00000', '00000', '00000', '00000', '00000', '00000', '00000'],
      '5': ['0000'],
      '6': ['0000', '0000', '0000'],
      '7': ['000'],
      '8': ['00'],
    };
  } else {
    return {
      ĐB: ['00000'],
      '1': ['00000'],
      '2': ['00000', '00000'],
      '3': ['00000', '00000', '00000', '00000', '00000', '00000'],
      '4': ['0000', '0000', '0000', '0000'],
      '5': ['0000', '0000', '0000', '0000', '0000', '0000'],
      '6': ['000', '000', '000'],
      '7': ['00', '00', '00', '00'],
    };
  }
}

// JSON mẫu cho đài xổ số theo ngày (phần nhỏ để minh họa)
export const sampleProvincesByDayJSON = {
  metadata: {
    version: '1.0',
    nguon: 'https://www.minhngoc.net.vn/ket-qua-xo-so',
    ngayLayDuLieu: '2025-03-21T05:08:58.614Z',
    tongSoMien: 3,
    tongSoNgay: 7,
  },
  duLieu: {
    'thu-hai': {
      'mien-bac': [
        {
          tinh: 'Hà Nội',
          ngay: '2025-03-17',
          thu: 'Thứ hai',
          mien: 'mien-bac',
        },
      ],
      'mien-trung': [
        {
          tinh: 'Phú Yên',
          maTinh: 'XSPY',
          ngay: '2025-03-17',
          thu: 'Thứ hai',
          mien: 'mien-trung',
        },
        {
          tinh: 'Thừa T. Huế',
          maTinh: 'XSTTH',
          ngay: '2025-03-17',
          thu: 'Thứ hai',
          mien: 'mien-trung',
        },
      ],
      'mien-nam': [
        {
          tinh: 'TP. HCM',
          maTinh: 'XSHCM - 3D2',
          ngay: '2025-03-17',
          thu: 'Thứ hai',
          mien: 'mien-nam',
        },
        {
          tinh: 'Đồng Tháp',
          maTinh: 'XSDT - T11',
          ngay: '2025-03-17',
          thu: 'Thứ hai',
          mien: 'mien-nam',
        },
        {
          tinh: 'Cà Mau',
          maTinh: 'XSCM - 25-T03K3',
          ngay: '2025-03-17',
          thu: 'Thứ hai',
          mien: 'mien-nam',
        },
      ],
    },
    // ... các ngày khác
  },
};

// JSON mẫu cho kết quả xổ số
export const sampleLotteryResultJSON = {
  date: '2025-03-17',
  region: 'M1',
  province: 'TP. HCM',
  results: {
    ĐB: ['123456'],
    '1': ['12345'],
    '2': ['12345'],
    '3': ['12345', '67890'],
    '4': ['12345', '23456', '34567', '45678', '56789', '67890', '78901'],
    '5': ['1234'],
    '6': ['1234', '2345', '3456'],
    '7': ['123'],
    '8': ['12'],
  },
};
```

## 8. Triển khai BetTypeService để quản lý loại cược

```typescript
import { createClient } from '@/lib/supabase/client';
import { BetType, BetSubtype, DaSubtype } from './types';

/**
 * Service quản lý các loại cược
 */
export class BetTypeService {
  /**
   * Lấy tất cả các loại cược có trong hệ thống
   */
  static async getAllBetTypes(): Promise<BetType[]> {
    const supabase = createClient();
    const { data, error } = await supabase.from('rules').select('*');

    if (error) {
      console.error('Error fetching bet types:', error);
      return [];
    }

    // Chuyển đổi từ dữ liệu DB sang dạng BetType
    return data.map((rule) => ({
      id: rule.rule_code,
      name: rule.name,
      description: rule.description || '',
      digits: rule.digits || 2,
      region: rule.region,
      payRate: rule.rate,
      subtypes: rule.variants || [],
      winLogic: rule.win_logic || {},
    }));
  }

  /**
   * Lấy thông tin loại cược theo ID
   */
  static async getBetTypeById(id: string): Promise<BetType | null> {
    const supabase = createClient();
    const { data, error } = await supabase.from('rules').select('*').eq('rule_code', id).single();

    if (error || !data) {
      console.error('Error fetching bet type:', error);
      return null;
    }

    return {
      id: data.rule_code,
      name: data.name,
      description: data.description || '',
      digits: data.digits || 2,
      region: data.region,
      payRate: data.rate,
      subtypes: data.variants || [],
      winLogic: data.win_logic || {},
    };
  }

  /**
   * Lấy các loại cược theo miền
   */
  static async getBetTypesByRegion(region: 'M1' | 'M2' | 'both'): Promise<BetType[]> {
    const supabase = createClient();
    let query = supabase.from('rules').select('*');

    if (region !== 'both') {
      // Lấy cả "both" và region cụ thể
      query = query.or(`region.eq.${region},region.eq.both`);
    }

    const { data, error } = await query;

    if (error) {
      console.error('Error fetching bet types by region:', error);
      return [];
    }

    return data.map((rule) => ({
      id: rule.rule_code,
      name: rule.name,
      description: rule.description || '',
      digits: rule.digits || 2,
      region: rule.region,
      payRate: rule.rate,
      subtypes: rule.variants || [],
      winLogic: rule.win_logic || {},
    }));
  }

  /**
   * Lấy thông tin subtype của loại cược
   */
  static getSubtypeInfo(betType: BetType, subtypeId: string): BetSubtype | DaSubtype | null {
    if (!betType.subtypes) return null;

    for (const subtype of betType.subtypes) {
      if (subtype.id === subtypeId) {
        return subtype;
      }
    }

    return null;
  }

  /**
   * Tính số tiền cược dựa trên loại cược, subtype và mệnh giá
   */
  static calculateBetAmount(
    betType: BetType,
    subtypeId: string | undefined,
    betAmount: number,
    region: 'M1' | 'M2' | 'both'
  ): number {
    // Đầu Đuôi
    if (betType.id === 'dd' && subtypeId) {
      let total = 0;

      if (region === 'M1' || region === 'both') {
        if (subtypeId === 'dd') total += betAmount * 2;
        else total += betAmount;
      }

      if (region === 'M2' || region === 'both') {
        if (subtypeId === 'dd') total += betAmount * 5;
        else if (subtypeId === 'dau') total += betAmount * 4;
        else total += betAmount;
      }

      return total;
    }

    // Xỉu Chủ
    else if (betType.id === 'xc' && subtypeId) {
      let total = 0;

      if (region === 'M1' || region === 'both') {
        if (subtypeId === 'xc') total += betAmount * 2;
        else total += betAmount;
      }

      if (region === 'M2' || region === 'both') {
        if (subtypeId === 'xc') total += betAmount * 4;
        else if (subtypeId === 'dau') total += betAmount * 3;
        else total += betAmount;
      }

      return total;
    }

    // Bao Lô N
    else if (['b2', 'b3', 'b4'].includes(betType.id)) {
      const digits = parseInt(betType.id.charAt(1));
      const rateM1 = digits === 2 ? 18 : digits === 3 ? 17 : 16;
      const rateM2 = digits === 2 ? 27 : digits === 3 ? 23 : 20;

      let total = 0;

      if (region === 'M1' || region === 'both') {
        total += betAmount * rateM1;
      }

      if (region === 'M2' || region === 'both') {
        total += betAmount * rateM2;
      }

      return total;
    }

    // Bao 7 Lô
    else if (betType.id === 'b7l') {
      return betAmount * 7;
    }

    // Bao 8 Lô
    else if (betType.id === 'b8l') {
      return betAmount * 8;
    }

    // Nhất To
    else if (betType.id === 'nt') {
      return betAmount;
    }

    // Xiên
    else if (betType.id === 'x') {
      return betAmount * 27;
    }

    // Đá
    else if (betType.id === 'da' && subtypeId) {
      const rates: Record<string, number> = {
        da2: 1,
        da3: 3,
        da4: 6,
        da5: 10,
      };

      return betAmount * (rates[subtypeId] || 1);
    }

    return betAmount;
  }

  /**
   * Tính tiền thắng tiềm năng
   */
  static calculatePotentialWin(
    betType: BetType,
    subtypeId: string | undefined,
    betAmount: number,
    digits?: number
  ): number {
    // Lấy tỷ lệ thắng dựa vào loại cược
    let payRate = 0;

    if (betType.id === 'dd' || betType.id === 'nt' || betType.id === 'b2') {
      payRate = 75;
    } else if (betType.id === 'xc' || betType.id === 'b3') {
      payRate = 650;
    } else if (betType.id === 'b4') {
      payRate = 5500;
    } else if ((betType.id === 'b7l' || betType.id === 'b8l') && digits) {
      if (digits === 2) payRate = 75;
      else if (digits === 3) payRate = 650;
      else if (digits === 4) payRate = 5500;
    } else if (betType.id === 'x' && subtypeId) {
      if (subtypeId === 'x2') payRate = 75;
      else if (subtypeId === 'x3') payRate = 40;
      else if (subtypeId === 'x4') payRate = 250;
    } else if (betType.id === 'da' && subtypeId) {
      if (subtypeId === 'da2') payRate = 12.5;
      else if (subtypeId === 'da3')
        payRate = 25; // Lowest rate
      else if (subtypeId === 'da4')
        payRate = 75; // Lowest rate
      else if (subtypeId === 'da5') payRate = 500; // Lowest rate
    }

    return betAmount * payRate;
  }

  /**
   * Kiểm tra số có hợp lệ với loại cược không
   */
  static isValidNumberForBetType(number: string, betType: BetType): boolean {
    if (['dd', 'nt', 'b2'].includes(betType.id)) {
      // Cần 2 chữ số
      return /^\d{2}$/.test(number);
    } else if (['xc', 'b3'].includes(betType.id)) {
      // Cần 3 chữ số
      return /^\d{3}$/.test(number);
    } else if (betType.id === 'b4') {
      // Cần 4 chữ số
      return /^\d{4}$/.test(number);
    } else if (['b7l', 'b8l'].includes(betType.id)) {
      // Có thể là 2, 3 hoặc 4 chữ số
      return /^\d{2,4}$/.test(number);
    } else if (['x', 'da'].includes(betType.id)) {
      // Cần 2 chữ số cho mỗi cặp
      return /^\d{2}$/.test(number);
    }

    return false;
  }
}

export default BetTypeService;
```

## 9. Triển khai ResultVerificationService để đối soát kết quả

```typescript
import { createClient } from '@/lib/supabase/client';
import { BetType, LotteryResult, BetCheckResult } from './types';
import BetTypeService from './bet-type-service';

interface BetData {
  id: string;
  user_id: string;
  created_at: string;
  draw_date: string;
  rule_id: string;
  subtype: string | null;
  amount: number;
  chosen_numbers: string[];
  total_amount: number;
  potential_win: number;
  region: string;
}

/**
 * Service xử lý đối soát kết quả cược
 */
export class ResultVerificationService {
  /**
   * Kiểm tra kết quả cược dựa trên các thông số đầu vào
   * @param betId ID của vé cược
   * @param lotteryResult Kết quả xổ số
   * @returns Kết quả đối soát
   */
  static async verifyBet(
    betId: string,
    lotteryResult: LotteryResult
  ): Promise<BetCheckResult | null> {
    try {
      // Lấy thông tin vé cược
      const betData = await this.getBetData(betId);
      if (!betData) return null;

      // Lấy thông tin loại cược
      const betType = await BetTypeService.getBetTypeById(betData.rule_id);
      if (!betType) return null;

      // Xác định các số trúng
      const matchedNumbers = await this.checkMatchedNumbers(
        betData.chosen_numbers,
        betType,
        betData.subtype,
        lotteryResult
      );

      // Tính toán số tiền thắng
      const winAmount = this.calculateWinAmount(
        matchedNumbers,
        betType,
        betData.subtype,
        betData.amount
      );

      // Tạo kết quả đối soát
      return {
        betId: betData.id,
        userId: betData.user_id,
        betDate: new Date(betData.created_at),
        drawDate: new Date(betData.draw_date),
        betType: betData.rule_id,
        betSubtype: betData.subtype || undefined,
        betAmount: betData.amount,
        numbers: betData.chosen_numbers,
        totalAmount: betData.total_amount,
        winAmount,
        matchedNumbers,
        isWin: winAmount > 0,
      };
    } catch (error) {
      console.error('Error verifying bet:', error);
      return null;
    }
  }

  /**
   * Lấy thông tin vé cược từ database
   */
  private static async getBetData(betId: string): Promise<BetData | null> {
    const supabase = createClient();
    const { data, error } = await supabase.from('bets').select('*').eq('id', betId).single();

    if (error || !data) {
      console.error('Error fetching bet data:', error);
      return null;
    }

    return data as BetData;
  }

  /**
   * Kiểm tra các số trúng
   */
  private static async checkMatchedNumbers(
    chosenNumbers: string[],
    betType: BetType,
    betSubtype: string | null,
    lotteryResult: LotteryResult
  ): Promise<
    {
      number: string;
      matches: {
        prize: string;
        matchType: string;
        value: string;
      }[];
    }[]
  > {
    const matchedNumbers: {
      number: string;
      matches: {
        prize: string;
        matchType: string;
        value: string;
      }[];
    }[] = [];

    // Xử lý theo từng loại cược
    for (const number of chosenNumbers) {
      const matches: {
        prize: string;
        matchType: string;
        value: string;
      }[] = [];

      // Đầu Đuôi (dd)
      if (betType.id === 'dd') {
        // Kiểm tra đầu nếu là 'dd' hoặc 'dau'
        if (betSubtype === 'dd' || betSubtype === 'dau') {
          const headPrize = lotteryResult.region === 'M1' ? '8' : '7';
          for (const lotteryNumber of lotteryResult.results[headPrize] || []) {
            if (lotteryNumber === number) {
              matches.push({
                prize: headPrize,
                matchType: 'full',
                value: lotteryNumber,
              });
            }
          }
        }

        // Kiểm tra đuôi nếu là 'dd' hoặc 'duoi'
        if (betSubtype === 'dd' || betSubtype === 'duoi') {
          for (const lotteryNumber of lotteryResult.results['ĐB'] || []) {
            if (lotteryNumber.slice(-2) === number) {
              matches.push({
                prize: 'ĐB',
                matchType: 'last2',
                value: lotteryNumber,
              });
            }
          }
        }
      }

      // Xỉu Chủ (xc)
      else if (betType.id === 'xc') {
        // Kiểm tra đầu nếu là 'xc' hoặc 'dau'
        if (betSubtype === 'xc' || betSubtype === 'dau') {
          const headPrize = lotteryResult.region === 'M1' ? '7' : '6';
          for (const lotteryNumber of lotteryResult.results[headPrize] || []) {
            if (lotteryNumber === number) {
              matches.push({
                prize: headPrize,
                matchType: 'full',
                value: lotteryNumber,
              });
            }
          }
        }

        // Kiểm tra đuôi nếu là 'xc' hoặc 'duoi'
        if (betSubtype === 'xc' || betSubtype === 'duoi') {
          for (const lotteryNumber of lotteryResult.results['ĐB'] || []) {
            if (lotteryNumber.slice(-3) === number) {
              matches.push({
                prize: 'ĐB',
                matchType: 'last3',
                value: lotteryNumber,
              });
            }
          }
        }
      }

      // Bao Lô 2 (b2)
      else if (betType.id === 'b2') {
        // Duyệt qua tất cả các giải để kiểm tra 2 số cuối
        for (const prize in lotteryResult.results) {
          for (const lotteryNumber of lotteryResult.results[prize] || []) {
            if (lotteryNumber.slice(-2) === number) {
              matches.push({
                prize,
                matchType: 'last2',
                value: lotteryNumber,
              });
            }
          }
        }
      }

      // Bao Lô 3 (b3)
      else if (betType.id === 'b3') {
        // Duyệt qua tất cả các giải để kiểm tra 3 số cuối
        for (const prize in lotteryResult.results) {
          for (const lotteryNumber of lotteryResult.results[prize] || []) {
            if (lotteryNumber.slice(-3) === number) {
              matches.push({
                prize,
                matchType: 'last3',
                value: lotteryNumber,
              });
            }
          }
        }
      }

      // Bao Lô 4 (b4)
      else if (betType.id === 'b4') {
        // Duyệt qua tất cả các giải để kiểm tra 4 số cuối
        for (const prize in lotteryResult.results) {
          for (const lotteryNumber of lotteryResult.results[prize] || []) {
            if (lotteryNumber.slice(-4) === number) {
              matches.push({
                prize,
                matchType: 'last4',
                value: lotteryNumber,
              });
            }
          }
        }
      }

      // Bao 7 Lô (b7l)
      else if (betType.id === 'b7l' && lotteryResult.region === 'M1') {
        const digits = number.length;
        const specificPrizes = ['ĐB', '5', '6', '6', '6', '7', '8'];

        // Kiểm tra số với 7 lô cụ thể
        for (let i = 0; i < specificPrizes.length; i++) {
          const prize = specificPrizes[i];
          // Lấy lô tương ứng
          const lotteryNumbers = lotteryResult.results[prize] || [];
          const lotteryNumber = lotteryNumbers[prize === '6' ? i - 3 : 0]; // Đặc biệt xử lý giải 6 có 3 lô

          if (lotteryNumber && lotteryNumber.slice(-digits) === number) {
            matches.push({
              prize,
              matchType: `last${digits}`,
              value: lotteryNumber,
            });
          }
        }
      }

      // Bao 8 Lô (b8l)
      else if (betType.id === 'b8l' && lotteryResult.region === 'M2') {
        const digits = number.length;
        const specificPrizes = ['ĐB', '3', '4', '5', '6', '6', '6', '7'];

        // Kiểm tra số với 8 lô cụ thể
        for (let i = 0; i < specificPrizes.length; i++) {
          const prize = specificPrizes[i];
          // Lấy lô tương ứng
          const lotteryNumbers = lotteryResult.results[prize] || [];
          const lotteryNumber = lotteryNumbers[prize === '6' ? i - 4 : 0]; // Đặc biệt xử lý giải 6 có 3 lô

          if (lotteryNumber && lotteryNumber.slice(-digits) === number) {
            matches.push({
              prize,
              matchType: `last${digits}`,
              value: lotteryNumber,
            });
          }
        }
      }

      // Nhất To (nt)
      else if (betType.id === 'nt') {
        // Kiểm tra 2 số cuối của giải Nhất
        for (const lotteryNumber of lotteryResult.results['1'] || []) {
          if (lotteryNumber.slice(-2) === number) {
            matches.push({
              prize: '1',
              matchType: 'last2',
              value: lotteryNumber,
            });
          }
        }
      }

      // Xiên (x) và Đá (da)
      // Cần xử lý riêng vì phức tạp

      if (matches.length > 0) {
        matchedNumbers.push({ number, matches });
      }
    }

    // Xử lý đặc biệt cho Xiên (x) và Đá (da)
    if (betType.id === 'x' || betType.id === 'da') {
      return this.checkComplexBets(chosenNumbers, betType, betSubtype, lotteryResult);
    }

    return matchedNumbers;
  }

  /**
   * Kiểm tra kết quả cho các loại cược phức tạp (Xiên, Đá)
   */
  private static async checkComplexBets(
    chosenNumbers: string[],
    betType: BetType,
    betSubtype: string | null,
    lotteryResult: LotteryResult
  ): Promise<
    {
      number: string;
      matches: {
        prize: string;
        matchType: string;
        value: string;
      }[];
    }[]
  > {
    const result: {
      number: string;
      matches: {
        prize: string;
        matchType: string;
        value: string;
      }[];
    }[] = [];

    // Tạo danh sách tất cả các số 2 chữ số trong kết quả
    const allTwoDigitsNumbers: string[] = [];
    for (const prize in lotteryResult.results) {
      for (const lotteryNumber of lotteryResult.results[prize] || []) {
        allTwoDigitsNumbers.push(lotteryNumber.slice(-2));
      }
    }

    // Xiên (x)
    if (betType.id === 'x') {
      // Kiểm tra xem tất cả các số đã chọn có trong kết quả không
      const allFound = chosenNumbers.every((number) => allTwoDigitsNumbers.includes(number));

      if (allFound) {
        // Tạo matches cho mỗi số trong chosenNumbers
        for (const number of chosenNumbers) {
          const matches = [];
          for (const prize in lotteryResult.results) {
            for (const lotteryNumber of lotteryResult.results[prize] || []) {
              if (lotteryNumber.slice(-2) === number) {
                matches.push({
                  prize,
                  matchType: 'last2',
                  value: lotteryNumber,
                });
                break; // Chỉ cần tìm thấy 1 lần
              }
            }
          }

          if (matches.length > 0) {
            result.push({ number, matches });
          }
        }
      }
    }

    // Đá (da)
    else if (betType.id === 'da') {
      // Đếm số lượng số trúng và số trúng nhiều lần
      const matchCounts: Record<string, number> = {};
      for (const number of chosenNumbers) {
        matchCounts[number] = 0;
        for (const lotteryNumber of allTwoDigitsNumbers) {
          if (lotteryNumber === number) {
            matchCounts[number]++;
          }
        }
      }

      // Đếm số lượng số trúng 1 lần, 2 lần, 3 lần
      let count1 = 0,
        count2 = 0,
        count3 = 0;

      for (const number in matchCounts) {
        if (matchCounts[number] === 1) count1++;
        else if (matchCounts[number] === 2) count2++;
        else if (matchCounts[number] >= 3) count3++;
      }

      // Tạo matches cho mỗi số trong chosenNumbers nếu trúng
      for (const number of chosenNumbers) {
        if (matchCounts[number] > 0) {
          const matches = [];

          for (const prize in lotteryResult.results) {
            for (const lotteryNumber of lotteryResult.results[prize] || []) {
              if (lotteryNumber.slice(-2) === number) {
                matches.push({
                  prize,
                  matchType: 'last2',
                  value: lotteryNumber,
                });
              }
            }
          }

          if (matches.length > 0) {
            result.push({ number, matches });
          }
        }
      }
    }

    return result;
  }

  /**
   * Tính toán số tiền thắng
   */
  private static calculateWinAmount(
    matchedNumbers: {
      number: string;
      matches: {
        prize: string;
        matchType: string;
        value: string;
      }[];
    }[],
    betType: BetType,
    betSubtype: string | null,
    betAmount: number
  ): number {
    if (matchedNumbers.length === 0) return 0;

    // Bao Lô và các loại cược đơn
    if (['b2', 'b3', 'b4', 'dd', 'xc', 'nt', 'b7l', 'b8l'].includes(betType.id)) {
      // Đếm tổng số lô trúng từ tất cả các số
      let totalMatches = 0;
      for (const matchedNumber of matchedNumbers) {
        totalMatches += matchedNumber.matches.length;
      }

      // Tính tiền thắng dựa vào loại cược
      let payRate = 0;
      if (['dd', 'b2', 'nt'].includes(betType.id)) {
        payRate = 75;
      } else if (['xc', 'b3'].includes(betType.id)) {
        payRate = 650;
      } else if (betType.id === 'b4') {
        payRate = 5500;
      } else if (['b7l', 'b8l'].includes(betType.id)) {
        // Xác định số chữ số của b7l/b8l
        const digits = matchedNumbers[0].number.length;
        if (digits === 2) payRate = 75;
        else if (digits === 3) payRate = 650;
        else if (digits === 4) payRate = 5500;
      }

      return betAmount * payRate * totalMatches;
    }

    // Xiên (x)
    else if (betType.id === 'x') {
      // Xác định số lượng cặp số
      const count = betSubtype ? parseInt(betSubtype.slice(1)) : 2;

      // Chỉ thắng khi tất cả các số đều trúng
      if (matchedNumbers.length === count) {
        let payRate = 0;
        if (count === 2) payRate = 75;
        else if (count === 3) payRate = 40;
        else if (count === 4) payRate = 250;

        return betAmount * payRate;
      }
    }

    // Đá (da)
    else if (betType.id === 'da') {
      // Đếm số lô trúng cho mỗi số
      const numberCounts: Record<string, number> = {};
      for (const matchedNumber of matchedNumbers) {
        numberCounts[matchedNumber.number] = matchedNumber.matches.length;
      }

      // Đếm số lượng số trúng 1 lần, 2 lần, 3 lần
      const counts = Object.values(numberCounts);
      let count1 = 0,
        count2 = 0,
        count3 = 0;

      for (const count of counts) {
        if (count === 1) count1++;
        else if (count === 2) count2++;
        else if (count >= 3) count3++;
      }

      // Xác định loại trúng và tỷ lệ thưởng
      let payRate = 0;
      const count = betSubtype ? parseInt(betSubtype.slice(2)) : 2;

      if (count === 2 && matchedNumbers.length === 2) {
        payRate = 12.5;
      } else if (count === 3) {
        if (matchedNumbers.length === 3)
          payRate = 37.5; // Trúng đủ 3 số
        else if (matchedNumbers.length === 2 && count2 === 1)
          payRate = 43.75; // Trúng 2 số + 1 số về 2 lần
        else if (matchedNumbers.length === 2) payRate = 25; // Trúng 2 số không kèm số nào về 2 lần
      } else if (count === 4) {
        if (matchedNumbers.length === 4)
          payRate = 250; // Trúng đủ 4 số
        else if (matchedNumbers.length === 3 && count3 === 1)
          payRate = 750; // Trúng 3 số + 1 số về 3 lần
        else if (matchedNumbers.length === 3 && count2 === 1)
          payRate = 500; // Trúng 3 số + 1 số về 2 lần
        else if (matchedNumbers.length === 2 && count2 === 2)
          payRate = 150; // Trúng 2 số + 2 số về 2 lần
        else if (matchedNumbers.length === 2 && count2 === 1) payRate = 75; // Trúng 2 số + 1 số về 2 lần
      } else if (count === 5) {
        if (matchedNumbers.length === 5)
          payRate = 1250; // Trúng đủ 5 số
        else if (matchedNumbers.length === 4 && count3 === 1)
          payRate = 3750; // Trúng 4 số + 1 số về 3 lần
        else if (matchedNumbers.length === 4 && count2 === 1)
          payRate = 2500; // Trúng 4 số + 1 số về 2 lần
        else if (matchedNumbers.length === 3 && count2 === 2)
          payRate = 750; // Trúng 3 số + 2 số về 2 lần
        else if (matchedNumbers.length === 3 && count2 === 1) payRate = 500; // Trúng 3 số + 1 số về 2 lần
      }

      return betAmount * payRate;
    }

    return 0;
  }

  /**
   * Lưu kết quả đối soát vào database
   */
  static async saveVerificationResult(betId: string, result: BetCheckResult): Promise<boolean> {
    try {
      const supabase = createClient();

      // Cập nhật thông tin vé cược
      const { error } = await supabase
        .from('bets')
        .update({
          result: result.matchedNumbers,
          status: result.isWin ? 'won' : 'lost',
          won_amount: result.winAmount,
          updated_at: new Date().toISOString(),
        })
        .eq('id', betId);

      if (error) {
        console.error('Error saving verification result:', error);
        return false;
      }

      return true;
    } catch (error) {
      console.error('Error saving verification result:', error);
      return false;
    }
  }
}

export default ResultVerificationService;
```

# Tổng kết

Từ quá trình phân tích quy tắc cá cược xổ số, tôi đã xây dựng các thành phần cơ bản sau cho hệ thống:

## 1. Phân tích và mô hình hóa dữ liệu

- **8 loại cược chính** bao gồm Đầu Đuôi, Xỉu Chủ, Bao Lô N, Bao 7 Lô, Bao 8 Lô, Nhất To, Xiên, và Đá
- **Cấu trúc dữ liệu JSON** cho các loại cược với đầy đủ thông tin về cách tính tiền đóng, tỷ lệ thắng
- **TypeScript interfaces** cho tất cả các đối tượng liên quan

## 2. Utility Functions

- **Tính toán tiền cược**: Các hàm tính tiền đóng cho từng loại cược dựa trên mệnh giá và miền áp dụng
- **Tạo số tự động**: Các hàm tạo số theo quy tắc con giáp, đảo số, tài xỉu, chẵn lẻ
- **Xác thực dữ liệu**: Hàm kiểm tra tính hợp lệ của số đối với từng loại cược

## 3. Services

- **BetTypeService**: Quản lý truy vấn, tính toán cho các loại cược
- **ResultVerificationService**: Xử lý logic đối soát kết quả xổ số với vé cược

## 4. Xử lý dữ liệu đài xổ số

- **Mẫu dữ liệu tỉnh/thành**: Cấu trúc JSON cho danh sách tỉnh theo ngày trong tuần
- **Mẫu kết quả xổ số**: Cấu trúc JSON cho kết quả xổ số

## Lưu ý quan trọng

1. Mỗi loại cược có cách tính tiền đóng và tỷ lệ thắng khác nhau, cần xử lý cẩn thận
2. Đối soát kết quả cho Xiên và Đá đặc biệt phức tạp, đòi hỏi xử lý nhiều trường hợp
3. Một số loại cược chỉ áp dụng cho M1 (miền Nam/Trung) hoặc M2 (miền Bắc)
4. Cần xử lý đặc biệt cho các loại cược có nhiều trường hợp thắng khác nhau

Với các thành phần đã xây dựng, bạn có thể tiếp tục phát triển các components UI như Form đặt cược và trang đối soát kết quả. Hệ thống này tuân thủ đúng quy tắc được mô tả trong tài liệu và sẵn sàng tích hợp vào ứng dụng Next.js với Supabase làm backend.
